<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>a1.idc1 · Test console</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        --bg: radial-gradient(circle at 10% -10%, #00c2b0, transparent 35%), radial-gradient(circle at 80% 0%, #3144ff, transparent 45%), #03040b;
        --panel: rgba(8, 12, 26, 0.86);
        --border: rgba(255, 255, 255, 0.1);
        --accent: #7ef2c9;
        --accent-2: #24c1ff;
        --subtle: #b4bad8;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: #f4f7ff;
        display: flex;
        justify-content: center;
        padding: clamp(1.5rem, 4vw, 3rem);
      }
      main {
        width: min(1100px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      header {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 28px;
        padding: clamp(1.6rem, 4vw, 2.8rem);
        box-shadow: 0 30px 70px rgba(0, 5, 20, 0.55);
      }
      .eyebrow {
        margin: 0 0 0.4rem;
        font-size: 0.9rem;
        letter-spacing: 0.32em;
        text-transform: uppercase;
        color: var(--accent);
      }
      h1 {
        margin: 0 0 0.6rem;
        font-size: clamp(2rem, 4.5vw, 2.8rem);
        letter-spacing: 0.08em;
      }
      p {
        margin: 0;
        color: var(--subtle);
        line-height: 1.6;
        max-width: 65ch;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.2rem;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 22px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        transition: transform 0.2s ease, border-color 0.2s ease;
      }
      .card:hover {
        transform: translateY(-4px);
        border-color: rgba(126, 242, 201, 0.35);
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.07);
        font-size: 0.8rem;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: var(--accent-2);
      }
      .card-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }
      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--subtle);
        transition: color 0.2s ease;
      }
      .status-dot {
        width: 0.6rem;
        height: 0.6rem;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 rgba(255, 255, 255, 0.35);
        transition: background 0.2s ease, box-shadow 0.2s ease;
      }
      .status-indicator[data-state='ok'] {
        color: #7ef2c9;
      }
      .status-indicator[data-state='ok'] .status-dot {
        background: #7ef2c9;
        box-shadow: 0 0 8px rgba(126, 242, 201, 0.6);
      }
      .status-indicator[data-state='error'] {
        color: #ff9b9b;
      }
      .status-indicator[data-state='error'] .status-dot {
        background: #ff6b6b;
        box-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
      }
      .status-indicator[data-state='idle'] {
        color: #b4bad8;
      }
      .status-indicator[data-state='idle'] .status-dot {
        background: rgba(255, 255, 255, 0.35);
        box-shadow: none;
      }
      .card h2 {
        margin: 0;
        font-size: 1.25rem;
      }
      .card p {
        margin: 0;
        color: var(--subtle);
      }
      .card a {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        margin-top: auto;
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }
      .card a::after {
        content: '↗';
        font-size: 1rem;
      }
      .test-url {
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        color: rgba(180, 186, 216, 0.85);
        font-family: 'JetBrains Mono', 'Fira Code', 'SFMono-Regular', Menlo, Consolas, monospace;
        margin: 0.35rem 0 0.75rem;
        word-break: break-all;
      }
      .providers-panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 26px;
        padding: clamp(1.25rem, 3vw, 2rem);
        box-shadow: 0 25px 60px rgba(4, 6, 18, 0.45);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }
      .providers-head {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: space-between;
        align-items: center;
      }
      .providers-head h2 {
        margin: 0.15rem 0 0.35rem;
        font-size: clamp(1.4rem, 3vw, 1.9rem);
      }
      .providers-body {
        min-height: 120px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 1rem;
        background: rgba(2, 4, 12, 0.5);
      }
      .providers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
      }
      .provider-card {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        background: rgba(14, 20, 36, 0.7);
      }
      .provider-card h3 {
        margin: 0;
        font-size: 1.05rem;
      }
      .provider-url {
        font-size: 0.78rem;
        color: rgba(180, 186, 216, 0.85);
        font-family: 'JetBrains Mono', 'Fira Code', 'SFMono-Regular', Menlo, Consolas, monospace;
        word-break: break-all;
        margin: 0;
      }
      .tool-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }
      .tool-chip {
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        color: #9acbf3;
      }
      .refresh-btn {
        appearance: none;
        border: 1px solid rgba(126, 242, 201, 0.5);
        background: rgba(4, 10, 24, 0.9);
        color: #7ef2c9;
        border-radius: 999px;
        padding: 0.45rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .refresh-btn:hover:not([disabled]) {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .refresh-btn[disabled] {
        opacity: 0.5;
        cursor: wait;
      }
      .providers-body[data-state='loading']::before,
      .providers-body[data-state='error']::before,
      .providers-body[data-state='empty']::before {
        content: attr(data-message);
        display: block;
        text-align: center;
        color: var(--subtle);
        padding: 1.25rem 0;
      }
      footer {
        text-align: center;
        color: var(--subtle);
        font-size: 0.9rem;
        padding: 1rem 0 0.5rem;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <p class="eyebrow">Surf Thailand · Edge node a1</p>
        <h1>Test surface</h1>
        <p>
          Handy launchpad for experiments deployed under <strong>/test</strong>. Use these quick links to verify Glama,
          APIs, and future diagnostics before promoting to the public site.
        </p>
      </header>

      <section class="grid" id="test-grid"></section>

      <section class="providers-panel" id="providers-panel">
        <div class="providers-head">
          <div>
            <p class="eyebrow" style="letter-spacing: 0.2em">Model context · providers</p>
            <h2>Registered MCP providers</h2>
            <p>Live list sourced from the <code>/providers</code> endpoint (same origin).</p>
          </div>
          <button id="providers-refresh" class="refresh-btn" type="button">Refresh</button>
        </div>
        <div class="providers-body" id="providers-body" data-state="loading" data-message="Loading providers…"></div>
      </section>

      <footer>
        Surf Thailand · a1.idc1 sandbox · Updated
        <time datetime="2025-12-05">Dec 5, 2025</time>
      </footer>
    </main>

    <script type="module">
      const cards = [
        {
          chip: 'Chat',
          title: 'Glama verification console',
          description: 'Full UI for exercising the Glama backend with temperature control and Enter-to-send toggle.',
          href: '/test/chat',
          cta: 'Open panel',
          status: { url: '/test/chat' }
        },
        {
          chip: 'Chat API',
          title: 'Proxy health + metadata',
          description: 'Returns JSON status from the Glama proxy (model, timestamp, readiness). Use for monitoring hooks.',
          href: '/test/chat/api/health',
          cta: 'View JSON',
          target: '_blank',
          status: { url: '/test/chat/api/health' }
        },
        {
          chip: 'Agents',
          title: 'Multi-agent smoke panel',
          description:
            'Mirrors the original node-1 multi-agent console for demonstrating saved sessions, archives, and crew selection.',
          href: '/test/agents',
          cta: 'Launch agents demo',
          status: { url: '/test/agents' }
        },
        {
          chip: 'Vision',
          title: 'Detects playground',
          description:
            'Upload frames or grab stills to run prompt presets against the GLAMA vision models and compare structured outputs.',
          href: '/test/detects',
          cta: 'Inspect detects UI',
          status: { url: '/test/detects' }
        },
        {
          chip: 'Vision API',
          title: 'Detects API health',
          description: 'Live health probe for the detects backend served via dev-host, ideal for automation checks.',
          href: '/test/detects/api/health',
          cta: 'View JSON',
          target: '_blank',
          status: { url: '/test/detects/api/health' }
        },
        {
          chip: 'Voice',
          title: 'Vaja TTS bench',
          description: 'Lightweight surface for piping sample scripts through Vaja and validating stream + download flow.',
          href: '/test/vaja',
          cta: 'Open Vaja UI',
          status: { url: '/test/vaja' }
        },
        {
          chip: 'Voice API',
          title: 'Vaja health endpoint',
          description: 'Checks the Vaja proxy so automations know when the voice stack is warmed up.',
          href: '/test/vaja/api/health',
          cta: 'View JSON',
          target: '_blank',
          status: { url: '/test/vaja/api/health' }
        },
        {
          chip: 'Docs',
          title: 'Test routing notes',
          description: 'Reference for how /test paths map to Caddy + systemd services. Perfect for onboarding and local mirroring.',
          href: 'https://idc1.surf-thailand.com/tony',
          cta: 'node-1 panel',
          target: '_blank',
          status: { state: 'idle', label: 'External' }
        }
      ];

      const toAbsoluteUrl = (href) => {
        try {
          return new URL(href, window.location.origin).href;
        } catch {
          return href;
        }
      };

      const grid = document.getElementById('test-grid');
      grid.innerHTML = cards
        .map(
          ({ chip, title, description, href, cta, target }, index) => `
            <article class="card" data-card-index="${index}">
              <div class="card-meta">
                <span class="chip">${chip}</span>
                <span class="status-indicator" data-state="pending" data-role="status">
                  <span class="status-dot"></span>
                  <span class="status-label">Checking…</span>
                </span>
              </div>
              <h2>${title}</h2>
              <p>${description}</p>
              <p class="test-url">${toAbsoluteUrl(href)}</p>
              <a href="${href}" ${target ? `target="${target}" rel="noreferrer"` : ''}>${cta}</a>
            </article>
          `
        )
        .join('');

      const setIndicator = (el, state, label) => {
        if (!el) return;
        el.dataset.state = state;
        const labelEl = el.querySelector('.status-label');
        if (labelEl) {
          labelEl.textContent = label;
        }
      };

      const checkStatus = async (card, indicatorEl) => {
        if (!indicatorEl) return;
        const statusConfig = card.status || {};

        if (statusConfig.state) {
          setIndicator(indicatorEl, statusConfig.state, statusConfig.label || 'External');
          return;
        }

        const statusUrl = statusConfig.url || card.href;

        if (!statusUrl) {
          setIndicator(indicatorEl, 'idle', 'Unknown');
          return;
        }

        const requestUrl = toAbsoluteUrl(statusUrl);

        try {
          const response = await fetch(requestUrl, { cache: 'no-store' });
          if (response.ok) {
            setIndicator(indicatorEl, 'ok', 'Online');
          } else {
            setIndicator(indicatorEl, 'error', `HTTP ${response.status}`);
          }
        } catch (error) {
          setIndicator(indicatorEl, 'error', 'Unavailable');
        }
      };

      requestAnimationFrame(() => {
        cards.forEach((card, index) => {
          const cardEl = grid.querySelector(`[data-card-index="${index}"]`);
          const indicatorEl = cardEl?.querySelector('[data-role="status"]');
          checkStatus(card, indicatorEl);
        });
      });

      const providersBody = document.getElementById('providers-body');
      const refreshBtn = document.getElementById('providers-refresh');

      const formatTools = (tools) => {
        if (!tools || !tools.length) {
          return '<span class="tool-chip" style="opacity:0.6">No default tools</span>';
        }
        return tools
          .map((tool) => `<span class="tool-chip">${tool}</span>`)
          .join('');
      };

      const healthState = (health) => {
        if (!health) return { state: 'idle', label: 'Unknown' };
        const label =
          health.detail && typeof health.detail === 'string'
            ? health.detail.slice(0, 40)
            : health.status === 'ok'
              ? 'Online'
              : 'Error';
        return { state: health.status === 'ok' ? 'ok' : 'error', label };
      };

      const formatUpdatedAt = (iso) => {
        if (!iso) return 'never';
        try {
          const date = new Date(iso);
          return date.toLocaleString();
        } catch {
          return iso;
        }
      };

      const buildProviderCards = (providers) => {
        if (!providers.length) {
          providersBody.dataset.state = 'empty';
          providersBody.dataset.message = 'No providers registered.';
          providersBody.innerHTML = '';
          return;
        }
        providersBody.dataset.state = '';
        providersBody.dataset.message = '';
        providersBody.innerHTML = `
          <div class="providers-grid">
            ${providers
              .map((provider) => {
                const { state, label } = healthState(provider.health);
                return `
                  <article class="provider-card">
                    <div class="card-meta">
                      <h3>${provider.name}</h3>
                      <span class="status-indicator" data-state="${state}">
                        <span class="status-dot"></span>
                        <span class="status-label">${label}</span>
                      </span>
                    </div>
                    <p class="provider-url">${provider.base_url}</p>
                    <p class="test-url">Capabilities: ${provider.capabilities_path || '—'}</p>
                    <p class="test-url">Updated: ${formatUpdatedAt(provider.capabilities_updated_at)}</p>
                    <div class="tool-row">${formatTools(provider.default_tools)}</div>
                  </article>
                `;
              })
              .join('')}
          </div>
        `;
      };

      const loadProviders = async (refresh = false) => {
        providersBody.dataset.state = 'loading';
        providersBody.dataset.message = 'Loading providers…';
        refreshBtn.disabled = true;
        try {
          const response = await fetch(`/providers${refresh ? '?refresh=true' : ''}`, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();
          buildProviderCards(data);
        } catch (error) {
          providersBody.dataset.state = 'error';
          providersBody.dataset.message = `Failed to load providers (${error.message})`;
          providersBody.innerHTML = '';
        } finally {
          refreshBtn.disabled = false;
        }
      };

      refreshBtn.addEventListener('click', () => loadProviders(true));
      loadProviders();
    </script>
  </body>
</html>

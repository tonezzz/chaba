name: Deploy idc1-stack

on:
  push:
    branches:
      - idc1-stack
  workflow_dispatch: {}

concurrency:
  group: deploy-idc1-stack
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.IDC1_STACK_SSH_HOST }}
          SSH_USER: ${{ secrets.IDC1_STACK_SSH_USER }}
          SSH_PORT: ${{ secrets.IDC1_STACK_SSH_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.IDC1_STACK_SSH_PRIVATE_KEY }}
          DEPLOY_PATH: ${{ secrets.IDC1_STACK_DEPLOY_PATH }}
          COMPOSE_PROFILE: ${{ secrets.IDC1_STACK_COMPOSE_PROFILE }}
        run: |
          set -euo pipefail

          if [ -z "${SSH_HOST}" ] || [ -z "${SSH_USER}" ] || [ -z "${SSH_PRIVATE_KEY}" ] || [ -z "${DEPLOY_PATH}" ]; then
            echo "Missing one or more required secrets: IDC1_STACK_SSH_HOST, IDC1_STACK_SSH_USER, IDC1_STACK_SSH_PRIVATE_KEY, IDC1_STACK_DEPLOY_PATH"
            exit 1
          fi

          SSH_PORT="${SSH_PORT:-22}"
          COMPOSE_PROFILE="${COMPOSE_PROFILE:-mcp-suite}"

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          echo "$SSH_PRIVATE_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> "$HOME/.ssh/known_hosts"

          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" "bash -lc '
            set -euo pipefail
            if [ ! -d \"$DEPLOY_PATH\" ]; then
              echo \"DEPLOY_PATH does not exist: $DEPLOY_PATH\" >&2
              exit 1
            fi
            cd \"$DEPLOY_PATH\"
            git fetch --all --prune
            git checkout idc1-stack
            git reset --hard origin/idc1-stack

            cd stacks/idc1-stack
            docker compose --profile \"$COMPOSE_PROFILE\" pull || true
            docker compose --profile \"$COMPOSE_PROFILE\" up -d --build
            docker compose ps
          '"

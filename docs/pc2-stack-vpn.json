{
  "schema_version": 1,
  "host": {
    "name": "pc2",
    "doc": "docs/host-pc2.json",
    "vpn": {
      "subnet": "10.8.0.0/24",
      "pc2_ip": "10.8.0.12",
      "idc1_ip": "10.8.0.1",
      "dns_ip": "10.8.0.1",
      "domains": ["pc2.vpn", "*.pc2.vpn"]
    }
  },
  "stack": {
    "id": "pc2-vpn",
    "description": "PC2 WireGuard client + VPN DNS + ingress prerequisites",
    "scope": ["wireguard", "dns", "firewall", "ingress"]
  },
  "known_good": {
    "wireguard": {
      "interface": "pc2",
      "expected_address": "10.8.0.12/32",
      "expected_dns": "10.8.0.1"
    },
    "dns": {
      "resolver": "10.8.0.1",
      "test_records": ["pc2.vpn", "1mcp.pc2.vpn", "dev-host.pc2.vpn"]
    }
  },
  "recovery": {
    "symptoms": [
      {
        "id": "vpn_no_dns",
        "description": "*.vpn hostnames do not resolve",
        "common_causes": ["WireGuard tunnel down", "NRPT rule missing", "VPN DNS not applied", "Windows DNS cache stale"]
      },
      {
        "id": "vpn_no_reach",
        "description": "Can resolve but cannot reach 10.8.0.1 or pc2 services",
        "common_causes": ["WireGuard handshake down", "Windows firewall blocks inbound", "routing/AllowedIPs mismatch"]
      }
    ],
    "verify": {
      "windows_powershell": [
        "ping 10.8.0.1",
        "nslookup pc2.vpn 10.8.0.1",
        "nslookup dev-host.pc2.vpn 10.8.0.1",
        "curl.exe http://pc2.vpn:3050/health",
        "curl.exe -k https://dev-host.pc2.vpn/api/health"
      ],
      "notes": [
        "For VPN DNS on Windows clients, prefer NRPT rules that send *.vpn to 10.8.0.1 instead of setting global DNS to 10.8.0.1."
      ]
    },
    "fix_steps": [
      {
        "id": "wg_start",
        "title": "Ensure WireGuard tunnel is up",
        "steps": [
          "Open WireGuard UI on PC2 and activate tunnel 'pc2'",
          "Confirm it has address 10.8.0.12 and can ping 10.8.0.1"
        ]
      },
      {
        "id": "dns_nrpt",
        "title": "Ensure Windows NRPT rule for .vpn",
        "steps": [
          "Confirm an NRPT rule exists for namespace '.vpn' to DNS server 10.8.0.1",
          "Flush DNS cache if needed (requires admin): ipconfig /flushdns"
        ]
      },
      {
        "id": "firewall_ports",
        "title": "Allow inbound 80/443 from VPN subnet on PC2",
        "steps": [
          "Ensure Windows Firewall allows inbound TCP 80 and 443 from 10.8.0.0/24",
          "If Caddy is used as VPN ingress, 80/443 must be reachable from other VPN clients"
        ]
      }
    ]
  }
}

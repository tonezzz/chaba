<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MCP Assistant</title>
    <style>
      :root { color-scheme: dark; }
      body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1020; color:#e6e6e6; }
      header { padding:14px 16px; border-bottom:1px solid #233; background:#0f1730; position:sticky; top:0; }
      header .title { font-weight:600; }
      #wrap { max-width: 980px; margin: 0 auto; }
      #chat { padding: 16px; display:flex; flex-direction:column; gap: 10px; }
      .msg { padding: 10px 12px; border:1px solid #223; border-radius: 10px; background:#0f1730; }
      .msg.user { border-color:#2a3a6a; background:#101b3a; }
      .msg.assistant { border-color:#2a6a3a; background:#0f2a1a; }
      .meta { font-size: 12px; opacity: 0.75; margin-bottom: 6px; }
      .content { white-space: pre-wrap; line-height: 1.35; }
      .row { display:flex; gap:10px; padding: 12px 16px; border-top: 1px solid #233; background:#0f1730; position: sticky; bottom: 0; }
      input, button { font-size: 14px; }
      input { flex: 1; padding: 10px 12px; border-radius: 10px; border:1px solid #233; background:#0b1020; color:#e6e6e6; }
      button { padding: 10px 14px; border-radius: 10px; border:1px solid #233; background:#16214a; color:#e6e6e6; cursor:pointer; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .pill { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #233; margin-left:8px; font-size: 12px; opacity:0.8; }
      a { color:#9bb7ff; }
    </style>
  </head>
  <body>
    <header>
      <div id="wrap">
        <span class="title">MCP Assistant</span>
        <span class="pill" id="health">loading…</span>
      </div>
    </header>

    <div id="wrap">
      <div id="chat"></div>
    </div>

    <div class="row">
      <input id="input" placeholder="Ask something…" autocomplete="off" />
      <button id="send">Send</button>
    </div>

    <script>
      const chatEl = document.getElementById('chat');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const healthEl = document.getElementById('health');

      const state = { conversationId: localStorage.getItem('mcp_assistant_conversation_id') || crypto.randomUUID() };
      localStorage.setItem('mcp_assistant_conversation_id', state.conversationId);

      function normalizeUrl(u) {
        try {
          const url = new URL(u);
          if (url.hostname === 'pc1.vpn') {
            url.hostname = window.location.hostname;
          }
          return url.toString();
        } catch {
          return u;
        }
      }

      function addMsg(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = role;
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = text;
        div.appendChild(meta);
        div.appendChild(content);
        chatEl.appendChild(div);
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }

      async function refreshHealth() {
        try {
          const r = await fetch('/health');
          const j = await r.json();
          healthEl.textContent = j.status === 'ok' ? 'ok' : 'bad';
        } catch {
          healthEl.textContent = 'down';
        }
      }

      async function send() {
        const text = (inputEl.value || '').trim();
        if (!text) return;
        inputEl.value = '';
        addMsg('user', text);
        sendBtn.disabled = true;
        try {
          const r = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ conversation_id: state.conversationId, text })
          });
          const j = await r.json();
          if (j.reply_type === 'text') {
            addMsg('assistant', j.text || '');
          } else if (j.reply_type === 'image') {
            addMsg('assistant', (j.text ? j.text + "\n" : "") + (j.url || ''));
          } else if (j.reply_type === 'image_job') {
            const jobId = j.job_id || j.jobId || '';
            const statusUrl = normalizeUrl(j.status_url || j.statusUrl || '');
            const resultUrl = normalizeUrl(j.result_url || j.resultUrl || '');
            addMsg('assistant', `Image job started.\njob_id=${jobId}\n${resultUrl}`);

            async function poll() {
              if (!resultUrl) return;
              for (let i = 0; i < 900; i++) {
                try {
                  const rr = await fetch(resultUrl, { method: 'GET' });
                  if (rr.ok) {
                    const jr = await rr.json();
                    const url = normalizeUrl(jr.imageUrl || jr.image_url || '');
                    if (url) {
                      addMsg('assistant', url);
                      const a = document.createElement('a');
                      a.href = url;
                      a.target = '_blank';
                      a.textContent = url;
                      const img = document.createElement('img');
                      img.src = url;
                      img.style.maxWidth = '100%';
                      img.style.borderRadius = '10px';
                      const wrap = document.createElement('div');
                      wrap.className = 'msg assistant';
                      const meta = document.createElement('div');
                      meta.className = 'meta';
                      meta.textContent = 'assistant';
                      wrap.appendChild(meta);
                      wrap.appendChild(a);
                      wrap.appendChild(document.createElement('br'));
                      wrap.appendChild(img);
                      chatEl.appendChild(wrap);
                      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                      return;
                    }
                  }
                } catch (e) {
                  // ignore
                }
                await new Promise(res => setTimeout(res, 1000));
              }
              if (statusUrl) addMsg('assistant', `Image job still running. Check: ${statusUrl}`);
            }

            poll();
          } else {
            addMsg('assistant', JSON.stringify(j, null, 2));
          }
        } catch (e) {
          addMsg('assistant', 'Error: ' + (e?.message || e));
        } finally {
          sendBtn.disabled = false;
          inputEl.focus();
        }
      }

      sendBtn.addEventListener('click', send);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') send();
      });

      refreshHealth();
      setInterval(refreshHealth, 5000);
    </script>
  </body>
</html>

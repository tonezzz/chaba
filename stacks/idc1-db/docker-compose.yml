version: "3.9"

x-default-service: &default-service
  restart: unless-stopped
  env_file:
    - .env
  networks:
    - idc1-db-net
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  # ollama: (MOVED to idc1-ai stack)
  # <<: *default-service
  # image: ollama/ollama:latest
  # container_name: idc1-ollama
  # ports:
  #   - "${OLLAMA_PORT:-11434}:11434"
  # volumes:
  #   - ollama-data:/root/.ollama
  # healthcheck:
  #   test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/11434' || exit 1"]
  #   interval: 30s
  #   timeout: 5s
  #   retries: 6

  qdrant:
    <<: *default-service
    image: qdrant/qdrant:latest
    container_name: idc1-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      - qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/6333' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 6

  mcp-rag:
    <<: *default-service
    build:
      context: ${MCP_RAG_BUILD_CONTEXT:-../../mcp/mcp-rag}
    container_name: idc1-mcp-rag
    ports:
      - "${MCP_RAG_PORT:-8455}:8055"
    environment:
      PORT: 8055
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_TEXT_COLLECTION: ${QDRANT_TEXT_COLLECTION:-rag_text}
      QDRANT_IMAGE_COLLECTION: ${QDRANT_IMAGE_COLLECTION:-rag_image}
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama.idc1-ai-net:11434}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      CLIP_MODEL: ${CLIP_MODEL:-clip-ViT-B-32}
    volumes:
      - mcp-rag-cache:/root/.cache
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8055/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 6
    depends_on:
      - qdrant

  mcp-memory:
    <<: *default-service
    build:
      context: ${MCP_MEMORY_BUILD_CONTEXT:-../../mcp/mcp-memory}
    ports:
      - "${MCP_MEMORY_PORT:-8470}:8470"
    environment:
      PORT: 8470
      MEMORY_FILE_PATH: /data/memory.jsonl
    volumes:
      - mcp-memory-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8470/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  idc1-db-net:
    driver: bridge
    external: true

volumes:
  mcp-memory-data:
  qdrant-data:
  mcp-rag-cache:

x-default-service: &default-service
  restart: unless-stopped
  env_file:
    - ${DEKA_STACK_ENV_FILE:-.env}
  networks:
    - deka-stack-net
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  mcp-rag-deka:
    <<: *default-service
    image: ${DEKA_MCP_RAG_DEKA_IMAGE:-pc1-stack-mcp-rag-deka:latest}
    container_name: deka-mcp-rag-deka
    ports:
      - "${DEKA_MCP_RAG_DEKA_PORT:-8058}:8055"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: 8055
      QDRANT_URL: ${DEKA_QDRANT_URL:-http://host.docker.internal:6333}
      QDRANT_TEXT_COLLECTION: ${DEKA_QDRANT_TEXT_COLLECTION:-deka_text}
      QDRANT_IMAGE_COLLECTION: ${DEKA_QDRANT_IMAGE_COLLECTION:-rag_image}
      OLLAMA_URL: ${DEKA_OLLAMA_URL:-http://host.docker.internal:11437}
      OLLAMA_EMBED_MODEL: ${DEKA_OLLAMA_EMBED_MODEL:-nomic-embed-text}
      CLIP_MODEL: ${DEKA_CLIP_MODEL:-clip-ViT-B-32}
    volumes:
      - deka-mcp-rag-cache:/root/.cache
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8055/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 6

  deka-chat-api:
    <<: *default-service
    image: ${DEKA_CHAT_API_IMAGE:-pc1-stack-deka-chat-api:latest}
    container_name: deka-deka-chat-api
    ports:
      - "${DEKA_CHAT_API_PORT:-8191}:8190"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: 8190
      MCP_RAG_DEKA_URL: ${DEKA_MCP_RAG_DEKA_URL:-http://mcp-rag-deka:8055}
      MCP_GLAMA_URL: ${DEKA_MCP_GLAMA_URL:-http://host.docker.internal:7241}
      MCP_DEKA_URL: ${DEKA_MCP_DEKA_URL:-http://host.docker.internal:8270}
      DEKA_TOP_K: ${DEKA_TOP_K:-6}
      DEKA_MIN_TOP_SCORE: ${DEKA_MIN_TOP_SCORE:-0.12}
      DEKA_CHAT_TIMEOUT_SECONDS: ${DEKA_CHAT_TIMEOUT_SECONDS:-60}
      DEKA_CHAT_LOG_LEVEL: ${DEKA_CHAT_LOG_LEVEL:-info}
    depends_on:
      - mcp-rag-deka
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8190/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  deka-chat-ui:
    <<: *default-service
    build:
      context: ./deka-chat-ui
    container_name: deka-deka-chat-ui
    ports:
      - "${DEKA_CHAT_UI_PORT:-8181}:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  deka-stack-net:
    name: deka-stack-net

volumes:
  deka-sqlite:
  deka-mcp-rag-cache:

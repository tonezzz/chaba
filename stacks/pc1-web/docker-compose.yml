x-default-service: &default-service
  restart: unless-stopped
  env_file:
    - ${PC1_WEB_ENV_FILE:-.env}
  networks:
    - pc1-web-net
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

services:
  openchat-ui:
    <<: *default-service
    build:
      context: ${OPENCHAT_UI_BUILD_CONTEXT:-../../sites/openchat-ui}
    container_name: pc1-web-openchat-ui
    extra_hosts:
      - "pc1.vpn:${PC1_VPN_IP:-10.8.0.11}"
    ports:
      - "${OPENCHAT_UI_PORT:-3170}:3000"
    environment:
      OPENAI_API_HOST: ${OPENCHAT_OPENAI_API_HOST:-http://pc1.vpn:8181}
      OPENAI_API_KEY: ${OPENCHAT_OPENAI_API_KEY:-sk-dummy}
      DEFAULT_MODEL: ${OPENCHAT_DEFAULT_MODEL:-glama-default}
      NEXT_PUBLIC_DEFAULT_TEMPERATURE: ${OPENCHAT_DEFAULT_TEMPERATURE:-0.5}
      NEXT_PUBLIC_DEFAULT_SYSTEM_PROMPT: ${OPENCHAT_DEFAULT_SYSTEM_PROMPT:-" "}
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 30s
      timeout: 5s
      retries: 3

  caddy:
    <<: *default-service
    image: caddy:2.8-alpine
    container_name: pc1-web-caddy
    ports:
      - "${CADDY_HTTP_PORT:-3080}:80"
      - "${CADDY_HTTPS_PORT:-3443}:443"
    environment:
      CADDY_INGRESS_DOMAINS: ${CADDY_INGRESS_DOMAINS:-localhost}
      CADDY_INGRESS_EMAIL: ${CADDY_INGRESS_EMAIL:-}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-config:/config
      - caddy-data:/data
    command: ["caddy", "run", "--config", "/etc/caddy/Caddyfile"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  dev-host:
    <<: *default-service
    build:
      context: ${DEV_HOST_BUILD_CONTEXT:-../../docker/dev-host}
      dockerfile: Dockerfile
    container_name: pc1-web-dev-host
    hostname: dev-host
    ports:
      - "${DEV_HOST_SSH_PORT:-2223}:22"
      - "${DEV_HOST_HTTP_PORT:-3100}:3000"
    environment:
      DEV_HOST_BASE_URL: ${DEV_HOST_BASE_URL:-http://pc1.vpn:3000}
      DEV_HOST_PC2_BASE_URL: ${DEV_HOST_PC2_BASE_URL:-http://dev-host.pc2:3000}
      A1_IDC1_BASE_URL: ${A1_IDC1_BASE_URL:-https://a1.idc1.surf-thailand.com}
      A1_IDC1_TEST_URL: ${A1_IDC1_TEST_URL:-https://a1.idc1.surf-thailand.com/test}
    volumes:
      - ../../:/workspaces/chaba:cached
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt/wsl/docker-desktop/run/docker.sock:/var/run/docker-desktop.sock:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  pc1-web-net:
    driver: bridge
    

volumes:
  caddy-config:
  caddy-data:
